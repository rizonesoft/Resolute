#include-once


Func _KillProcess($sProcess)

	Global $hToken, $PrUser, $aAdjust, $PList = 0

	; Enable "SeDebugPrivilege" privilege for obtain full access rights to another processes
	$hToken = _WinAPI_OpenProcessToken(BitOR($TOKEN_ADJUST_PRIVILEGES, $TOKEN_QUERY))
	_WinAPI_AdjustTokenPrivileges($hToken, $SE_DEBUG_NAME, $SE_PRIVILEGE_ENABLED, $aAdjust)

	If Not (@error Or @extended) Then

		$PList = ProcessList($sProcess)
		If IsArray($PList) Then

			For $x = 1 To $PList[0][0]

				If ProcessExists($PList[$x][0]) Then
					_MemoLoggingWrite("Malware process found [" & $PList[$x][0] & "]", 2)
					If ProcessClose($PList[$x][1]) Then
						_MemoLoggingWrite("Malware process closed successfully.", 1)
					Else
						Switch @error
							Case 1
								_MemoLoggingWrite("OpenProcess failed")
							Case 2
								_MemoLoggingWrite("AdjustTokenPrivileges Failed")
							Case 3
								_MemoLoggingWrite("TerminateProcess Failed")
							Case 4
								_MemoLoggingWrite("Cannot verify if process exists")
						EndSwitch

					EndIf
				EndIf

			Next

		EndIf

	EndIf

	; Enable SeDebugPrivilege privilege by default
	_WinAPI_AdjustTokenPrivileges($hToken, $aAdjust, 0, $aAdjust)
	_WinAPI_CloseHandle($hToken)

EndFunc


Func _MalRemFile($sFiName)

	If FileExists($sFiName) Then
		_MemoLoggingWrite("Malware file located @ [" & $sFiName & "]", 2)
		_MemoLoggingWrite("Removing the detected file.")
		_FileDeleteUnlock($sFiName)
		If Not FileExists($sFiName) Then
			_MemoLoggingWrite("The detected file was successfully removed.", 1)
		EndIf

	EndIf

EndFunc


Func _MalwareRemoveSystemDir($sMalFileName)

;~ 	_MemoLoggingWrite("Removing: [" & @SystemDir & "\" & $sMalFileName & "]", 3)
	_MalRemFile(@SystemDir & "\" & $sMalFileName)

EndFunc


Func _RemoveAppInit()

	_RegKeyExport("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows", "DllHooks.reg")
	_WriteToReg("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows", "AppInit_DLLs", "REG_SZ", "")
	If @error Then
		_ReturnRegistryErrorCode(@error)
	EndIf

EndFunc

Func _ReturnAppInitExtended($iRelacements, $sAppInitDll)

	If $iRelacements > 0 Then
		_MemoLoggingWrite("Bad DLL Injection found. [" & $sAppInitDll & "]", 3)
	EndIf

EndFunc


Func _FileDeleteUnlock($sFileSource)

	If FileExists($sFileSource) Then
		If Not FileDelete($sFileSource) Then
			_MemoLoggingWrite("The file could not be removed, attempting to unlock the file.", 3)
			FileSetAttrib($sFileSource, "-RASHNOT")
			If Not FileDelete($sFileSource) Then
				_MemoLoggingWrite("Still could not remove the file. The file will be removed on the next system boot.", 3)
				_FileDeleteOnReboot($sFileSource)
			EndIf
		EndIf
	EndIf

EndFunc


Func _FileDeleteOnReboot($sFileSource)
	Local $Return = DllCall('kernel32.dll', 'int', 'MoveFileExW', 'wstr', $sFileSource, 'ptr', 0, 'dword', 0x04)
    Return $Return[0]
EndFunc


Func _CleanProgDir($sMFile)

	_MalRemFile(@DesktopDir & "\" & $sMFile)
	_MalRemFile(@ProgramsCommonDir & "\" & $sMFile)
	_MalRemFile(@ProgramsDir & "\" & $sMFile)

EndFunc


Func _TerminateMalProcesses()

	Local $MalProcesses = 		"0.exe|1.exe|2.exe|3.exe|4.exe|7.exe|766.exe|ccagent.exe|ccmain.exe|cb.exe|davclnt.exe|digprot.exe|energy.exe|exec.exe|GetMusic.exe|mplay32xe.exe"
		$MalProcesses &= 		"|SG345d.exe|shl.exe|pornpassmanager.exe|Power-Antivirus-2009.exe|sdnsmain.exe|uninstall.exe|urpprot.exe|usrprot.exe|virus.exe|wianamp100[1].exe|winservices.exe"
		$MalProcesses &= 		"|YiqilaiLyrics.exe"

	Local $aProcs = StringSplit($MalProcesses, "|")

	For $i = 1 To $aProcs[0]
		If $aProcs[$i] <> "" Then
			_KillProcess($aProcs[$i])
			_DrawMalwareProgress(0, ($i / $aProcs[0]) * 100)
		EndIf
	Next

	$MalProcesses = ""
	_DrawMalwareProgress(0, 0)

EndFunc


Func _RemoveMalwareTraces($iMenuInd)

	_MemoLoggingWrite("Terminating known malware Processes.")
	_TerminateMalProcesses()
	_DrawMalwareProgress(0, 1)

	_DrawMalwareProgress(0, 2)
	_MemoLoggingWrite("Cleaning [" & @AppDataDir & "]")
	_MalRemFile(@AppDataDir & "\NPSWF32.dll")
	_MalRemFile(@AppDataDir & "\Protector*.exe")
	_MalRemFile(@AppDataDir & "\result.db")

	_DrawMalwareProgress(0, 3)
	;~ @DesktopDir = C:\Users\<Current User>\Desktop
	;~ @ProgramsCommonDir = C:\ProgramData\Microsoft\Windows\Start Menu\Programs
	;~ @ProgramsDir = C:\Users\Venom\AppData\Roaming\Microsoft\Windows\Start Menu\Programs
	_MemoLoggingWrite("Removing Malware Shortcuts.")
	_CleanProgDir("Windows Safety Series.lnk")


	_MemoLoggingWrite("Cleaning Malware Registry Traces.")
	_DrawMalwareProgress(0, 0)

EndFunc
